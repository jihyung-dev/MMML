<!DOCTYPE html>
<html  lang="ko"
       xmlns:th="http://www.thymeleaf.org"
       xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
       layout:decorate="~{layouts/default_layout}"
       th:with="IS_LOGIN=false,CONTENT_TITLE='판매자 등록 | 내돈내삶'">

<head>
    <link rel="stylesheet" th:href="@{/css/login.css}">
</head>

<!-- 🔹 로그인 컨텐츠: 화면 중앙 정렬 -->
<main layout:fragment="content"
      class="container d-flex justify-content-center align-items-center"
      style="min-height: 70vh;">

    <div class="login-container">
        <h2>판매자 등록</h2>

        <!-- 에러 메시지 (서버에서 온 공통 에러) -->
        <p th:if="${error}" class="error-text" th:text="${error}"></p>

        <!-- 로그인한 회원 정보 안내 (읽기 전용) -->
        <div class="info-box">
            <p>
                로그인 아이디:
                <strong th:text="${session.loginUser != null ? session.loginUser.memberId : '알 수 없음'}"></strong>
            </p>
            <p>
                이름:
                <strong th:text="${session.loginUser != null ? session.loginUser.memberName : '알 수 없음'}"></strong>
            </p>
        </div>

        <!-- 🔹 판매자(Seller) 정보 입력 폼 -->
        <form th:action="@{/seller/join}" method="post" th:object="${seller}">

            <!-- ✅ 사업자번호 + 실시간 중복 메시지 -->
            <label for="bizNo">사업자번호</label>
            <input type="text"
                   id="bizNo"
                   th:field="*{bizNo}"
                   placeholder="사업자번호 (- 없이 숫자만)"
                   required>
            <div id="bizNoMsg" class="small mt-1"></div>

            <label>상호명</label>
            <input type="text"
                   th:field="*{bizName}"
                   placeholder="예: OO마트, OO상사"
                   required>

            <label>업태/업종</label>
            <input type="text"
                   th:field="*{bizType}"
                   placeholder="예: 음식, 의류, 생활용품 등"
                   required>

            <label>사업장 주소</label>
            <input type="text"
                   th:field="*{bizAddress}"
                   placeholder="사업장 주소를 입력하세요"
                   required>

            <label>사업장 전화번호</label>
            <input type="text"
                   th:field="*{bizPhone}"
                   placeholder="예: 02-123-4567 또는 010-0000-0000"
                   required>

            <label>사업자 이메일</label>
            <input type="email"
                   th:field="*{bizEmail}"
                   placeholder="고객 문의용 이메일"
                   required>

            <button type="submit">판매자 등록하기</button>
        </form>

        <div class="login-links">
            <a th:href="@{/seller}">판매자 페이지로 가기</a> |
            <a th:href="@{/}">메인으로 돌아가기</a>
        </div>
    </div>

</main>

<!-- 🔹 레이아웃에 주입되는 script fragment -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const bizNoInput = document.getElementById('bizNo');
            const bizNoMsg = document.getElementById('bizNoMsg');

            console.log('join-seller script loaded');
            console.log('bizNoInput:', bizNoInput);
            console.log('bizNoMsg:', bizNoMsg);

            if (!bizNoInput || !bizNoMsg) {
                // 요소 못 찾으면 바로 return
                return;
            }

            // ✅ 컨텍스트패스 포함해서 서버 URL 생성
            const checkUrl = /*[[ @{/seller/api/check-biz-no} ]]*/ '/seller/api/check-biz-no';
            console.log('checkUrl =', checkUrl);

            let bizNoTimer = null;

            // 사용자가 타이핑할 때마다 (input 이벤트)
            bizNoInput.addEventListener('input', function () {
                const value = bizNoInput.value.trim();

                // 입력이 없으면 메시지 초기화
                if (value === '') {
                    bizNoMsg.textContent = '';
                    bizNoMsg.className = 'small mt-1';
                    return;
                }

                // 디바운스: 타이핑이 멈춘 뒤 300ms 후 요청
                if (bizNoTimer) {
                    clearTimeout(bizNoTimer);
                }

                bizNoTimer = setTimeout(() => {
                    console.log('calling', checkUrl, 'with', value);

                    fetch(checkUrl + '?bizNo=' + encodeURIComponent(value))
                        .then(res => res.json())
                        .then(data => {
                            console.log('duplicate result:', data);
                            if (data.duplicate) {
                                // 🔴 이미 등록된 사업자번호
                                bizNoMsg.textContent = '이미 사용 중인 사업자번호입니다.';
                                bizNoMsg.className = 'small mt-1 text-danger';
                            } else {
                                // 🟢 사용 가능
                                bizNoMsg.textContent = '사용 가능한 사업자번호입니다.';
                                bizNoMsg.className = 'small mt-1 text-success';
                            }
                        })
                        .catch(err => {
                            console.error('check-biz-no error:', err);
                            bizNoMsg.textContent = '사업자번호 확인 중 오류가 발생했습니다.';
                            bizNoMsg.className = 'small mt-1 text-danger';
                        });
                }, 300);
            });
        });
    </script>
</th:block>

</html>
