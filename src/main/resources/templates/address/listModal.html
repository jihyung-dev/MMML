<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <th:block th:fragment="addressListModal">

        <div class="card mb-3">
            <div class="card-body" id="selectedAddress">

            </div>
        </div>


        <!-- Button trigger modal -->
        <button type="button" class="btn btn-primary addressModalBtn" data-bs-toggle="modal" data-bs-target="#addressModal">
            ë°°ì†¡ì§€ ë³€ê²½
        </button>
        <div class="modal" style="border: 1px solid" id="addressModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">ë°°ì†¡ì§€ ì¡°íšŒ</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-danger" id="addressMsg"></div>
                        <div>
                            <button class="btn btn-primary mb-3 w-100" data-bs-toggle="collapse"  data-bs-target="#addAddressToggle"> + ë°°ì†¡ì§€ ì¶”ê°€</button>
                            <div class="collapse" id="addAddressToggle">
                                <form id="addAddressForm" class="border rounded p-3 mb-3">
                                    <h6 class="mb-3">ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€</h6>

                                    <div class="input-group mb-2">
                                        <input type="text" value="test" name="addressName" class="form-control" placeholder="ë°°ì†¡ì§€ ì´ë¦„ (ì§‘ / íšŒì‚¬)" required>
                                        <input type="text" value="í…ŒìŠ¤íŠ¸" name="recipientName" class="form-control" placeholder="ë°›ëŠ” ì‚¬ëŒ" required>
                                    </div>

                                    <!-- ì£¼ì†Œ ê²€ìƒ‰ ì˜ì—­ -->
                                    <div class="input-group mb-2" onclick="openPostcode()">
                                        <span class="input-group-text">ğŸ”</span>
                                        <input  type="text" value="í…ŒìŠ¤íŠ¸ë™" name="addressLine1" id="addressLine1" class="form-control" style="flex: 8;" placeholder="ë„ë¡œëª… ì£¼ì†Œ" required readonly>
                                        <input type="text" value="0011" name="zipcode" id="zipcode" class="form-control" style="flex: 4" placeholder="ìš°í¸ë²ˆí˜¸" required readonly>
                                    </div>
                                    <div class="mb-2">
                                        <input type="text" value="ìƒì„¸í…ŒìŠ¤íŠ¸" name="addressLine2" class="form-control" placeholder="ìƒì„¸ ì£¼ì†Œ (ì„ íƒ)">
                                    </div>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">ğŸ“</span>
                                        <input type="text" value="010-0000-0011" name="phone" class="form-control" placeholder="ì—°ë½ì²˜ : 010-1234-5678">
                                    </div>
                                    <div class="input-group mb-2">
                                        <input type="text" value="ê³µë™í˜„ê´€:1111" name="requestMessage" class="form-control" placeholder="ìš”ì²­ì‚¬í•­ : í˜„ê´€ ë¹„ë°€ë²ˆí˜¸ 7777">
                                    </div>
                                    <button type="submit" class="btn btn-success w-100 btn-sm">ë“±ë¡</button>
                                </form>

                            </div>
                        </div>

                        <div id="addressListBox"></div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

        <script>
            const addAddressForm=document.getElementById("addAddressForm");
            const addressModalBtn=document.querySelector(".addressModalBtn");
            const addressMsg=document.getElementById("addressMsg");
            const addressListBox=document.getElementById("addressListBox");
            const selectedAddress=document.getElementById("selectedAddress");
            //ë°°ì†¡ì§€ ê²€ìƒ‰ ì¹´ì¹´ì˜¤ api
            function openPostcode() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        document.querySelector("input[name='addressLine1']").value = data.roadAddress;
                        document.querySelector("input[name='zipcode']").value = data.zonecode;
                    }
                }).open();
            };

            const renderAddressSelected=(address)=>{
                return`   <!-- ë°°ì†¡ì§€ëª… + ê¸°ë³¸ë°°ì†¡ì§€ í‘œì‹œ -->
                <h5>
                    <span>${address.addressName}</span>
                    <span class="badge bg-primary ms-1">${address.isDefault ? 'ê¸°ë³¸ë°°ì†¡ì§€':''}</span>
                </h5>

                <!-- ë°›ëŠ” ì‚¬ëŒ -->
                <p class="mb-1">
                    <strong>ë°›ëŠ” ì‚¬ëŒ:</strong>
                    <span id="recipientName">${address.recipientName}</span>
                </p>

                <!-- ì£¼ì†Œ -->
                <p class="mb-1">
                    <strong>ì£¼ì†Œ:</strong>
                    <span id="addressLine1">${address.addressLine1}</span>
                    <span id="addressLine2">${address.addressLine2}</span>
                </p>

                <!-- ìš°í¸ë²ˆí˜¸ -->
                <p class="mb-1">
                    <strong>ìš°í¸ë²ˆí˜¸:</strong>
                    <span id="zipCode">${address.zipcode}</span>
                </p>

                <!-- ì—°ë½ì²˜ -->
                <p class="mb-1">
                    <strong>ì—°ë½ì²˜:</strong>
                    <span id="phone">${address.phone}</span>
                </p>

                <!-- ìš”ì²­ì‚¬í•­ -->
                <p class="mb-1">
                    <strong>ìš”ì²­ì‚¬í•­:</strong>
                    <span id="requestMeassage">${address.requestMessage}</span>
                </p>`;
            }
            const loadSelectedAddress=async()=>{
                let url="/api/address/default";
                const response=await fetch(url);
                if(response.ok){
                    const address= await response.json();
                    if(address){
                        selectedAddress.innerHTML=renderAddressSelected(address);

                    }
                }else if(response.status===404){
                    selectedAddress.innerHTML=`<div>"ë°°ì†¡ì§€ ë³€ê²½"ì„ ëˆ„ë¥´ê³  ë°°ì†¡ì§€ë¥¼ ë“±ë¡í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”.</div>`;
                }else if(response.status===400){
                    if(confirm("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”")){
                        location.href="/login";
                    }
                }else{
                    addressMsg.innerText="ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
                }

            }
            loadSelectedAddress();
            const renderAddress = (item) => {
               return`
 <div class="card mb-2 ${item.isDefault ? 'border-primary' : ''}">
    <div class="card-body">

        <div class="d-flex justify-content-between">
            <h5 class="card-title">${item.addressName}</h5>
            <div>
                <button class="btn btn-sm btn-outline-success"
                        onclick="setDefault(${item.id})" ${item.isDefault ? "hidden" : ""}>
                    ê¸°ë³¸ ë°°ì†¡ì§€ ë³€ê²½
                </button>
                <span>${item.isDefault ? "ê¸°ë³¸ ë°°ì†¡ì§€" : ""}</span>
            </div>
        </div>
        <div class="card-text my-2">
            <strong>ë°›ëŠ” ì‚¬ëŒ:</strong> ${item.recipientName}<br>
            <strong>ì£¼ì†Œ:</strong> ${item.addressLine1} ${item.addressLine2 || ""}<br>
            <strong>ìš°í¸ë²ˆí˜¸:</strong> ${item.zipcode}<br>
            <strong>ì—°ë½ì²˜:</strong> ${item.phone}<br>
            <strong>ìš”ì²­ì‚¬í•­:</strong> ${item.requestMessage || "-"}<br>
        </div>
        <div class="d-flex justify-content-end">
            <button class="btn btn-outline-primary me-1" onclick="editAddress(${item.id})">ìˆ˜ì •</button>
            <button class="btn btn-outline-danger me-1" onclick="deleteAddress(${item.id})">ì‚­ì œ</button>
        </div>
    </div>
</div>        `;
            };
            const renderAddressList=(addressList)=>{
                if(addressList && addressList.length>0){
                    let html="";
                    for(let address of addressList){
                        html+=renderAddress(address);
                    }
                    addressListBox.innerHTML=html;
                }else {
                    addressListBox.innerText= "<p class='text-muted'>ë“±ë¡ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                }

            }
            const loadAddressList = async () => {
                let url="/api/address";
                const response = await fetch(url);
                if(response.ok){
                    const addressList= await response.json();
                    renderAddressList(addressList);

                }else if(response.status===400){
                    if(confirm("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”")){
                        location.href="/login";
                    }
                }else{
                    addressMsg.innerText="ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
                }
            }
            addressModalBtn.addEventListener("click", loadAddressList);
            addAddressForm.addEventListener("submit", async (e)=>{
                e.preventDefault();
                let url="/api/address";
                const formData=new FormData(e.target);
                const jsonData=Object.fromEntries(formData.entries());
                const options={
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json"
                    },
                    body:JSON.stringify(jsonData)
                }
                const resonse=await fetch(url,options);
                if(resonse.ok){
                    alert("ë“±ë¡ ì„±ê³µ")
                    await loadAddressList()
                    // í¼ ì´ˆê¸°í™”
                    addAddressForm.reset();

                    // ì£¼ì†Œ ê²€ìƒ‰ í•„ë“œ readonlyë¼ì„œ ì¼ë¶€ ë¸Œë¼ìš°ì € ìë™ ì´ˆê¸°í™” ì•ˆë  ìˆ˜ ìˆì–´ì„œ ì§ì ‘ ì´ˆê¸°í™”
                    document.getElementById("addressLine1").value = "";
                    document.getElementById("zipcode").value = "";

                } else if(resonse.status === 400){
                    const errorText = await resonse.text();
                    addressMsg.innerText = errorText || "ì…ë ¥ ê°’ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.";
                    alert(errorText);
                } else {
                    addressMsg.innerText = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                }
            })
        </script>
    </th:block>
</body>
</html>