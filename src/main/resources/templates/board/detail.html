<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="'๊ฒ์๊ธ - ' + ${post.postTitle}"></title>
    <link rel="stylesheet" th:href="@{/css/detail.css}">
</head>
<body>

<div class="detail-container">

    <!-- ์ข์์ ์ -->
    <div>
        โค๏ธ <b th:text="${post.boardLikes.size()}"></b> ๋ช์ด ์ข์ํฉ๋๋ค
    </div>

    <!-- ์ข์์ / ์ทจ์ (๋ก๊ทธ์ธ ์ํ์์๋ง) -->
    <div th:if="${session.loginUser != null}">
        <form th:action="@{'/like/add/' + ${post.id}}" method="post" style="display:inline;">
            <button type="submit">์ข์์ ๐</button>
        </form>

        <form th:action="@{'/like/remove/' + ${post.id}}" method="post" style="display:inline;">
            <button type="submit">์ทจ์ ๐</button>
        </form>
    </div>

    <!-- ๋น๋ก๊ทธ์ธ ์๋ด -->
    <div th:if="${session.loginUser == null}">
        <p>
            ์ข์์๋ฅผ ๋๋ฅด๋ค๋ฉด <a href="/login">๋ก๊ทธ์ธ</a>์ด ํ์ํฉ๋๋ค.
        </p>
    </div>

    <h2 th:text="${post.postTitle}"></h2>

    <div class="detail-meta">
        <span>์นดํ๊ณ๋ฆฌ: <b th:text="${post.category}"></b></span>
        <span>์์ฑ์: <b th:text="${post.writer.memberNickname}"></b></span>
        <span>์์ฑ์ผ:
            <b th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></b>
        </span>
        <span>์กฐํ์: <b th:text="${post.viewCnt}"></b></span>
    </div>

    <div class="detail-content" th:text="${post.postContent}"></div>

    <hr/>

    <!-- ์์ / ์ญ์ ๋ฒํผ (์์ฑ์ ๋๋ ๊ด๋ฆฌ์๋ง ๋ธ์ถ) -->
    <th:block th:if="${session.loginUser != null
                 and (session.loginUser.memberId == post.writer.memberId
                      or session.loginUser.role == 'ADMIN')}">

        <a class="button" th:href="@{'/board/' + ${post.id} + '/edit'}">์์</a>

        <form th:action="@{'/board/' + ${post.id} + '/delete'}"
              method="post" style="display:inline;">
            <button class="comment-delete-btn">์ญ์</button>
        </form>
    </th:block>


    <button><a class="button" href="/board">๋ชฉ๋ก์ผ๋ก</a></button>

    <!-- ===========================
                ๋๊ธ ์์ญ
       =========================== -->
    <div class="comment-box">
        <h4>๋๊ธ</h4>

        <!-- ๋๊ธ ๋ชฉ๋ก -->
        <div th:each="c : ${post.boardComments}"
             th:class="'comment-item ' + (${c.parentComment != null} ? 'reply' : '')">

            <div>
                <span class="comment-author"
                      th:text="${c.writer.memberNickname}"></span>
                <span th:text="${#temporals.format(c.createdAt,'yyyy-MM-dd HH:mm')}"></span>
            </div>

            <div th:text="${c.commentContent}"></div>

            <!-- ๋๊ธ ์ญ์ ๋ฒํผ (์์ฑ์ or ๊ด๋ฆฌ์๋ง) -->
            <th:block th:if="${session.loginUser != null
                 and (session.loginUser.memberId == c.writer.memberId
                      or session.loginUser.role == 'ADMIN')}">
                <form th:action="@{'/comment/' + ${c.id} + '/delete'}"
                      method="post" style="display:inline;">
                    <input type="hidden" name="postId" th:value="${post.id}">
                    <button class="comment-delete-btn">์ญ์</button>
                </form>
            </th:block>


            <!-- ๋๋๊ธ ์์ฑ -->
            <details>
                <summary>๋ต๊ธ ๋ฌ๊ธฐ</summary>

                <!-- ๋ก๊ทธ์ธ O -->
                <form th:if="${session.loginUser != null}"
                      th:action="@{/comment/write}" method="post">
                    <input type="hidden" name="postId" th:value="${post.id}">
                    <input type="hidden" name="parentId" th:value="${c.id}">
                    <!-- ์์ฑ์ ๋๋ค์ ํ์ (readonly) -->
                    <input type="text"
                           th:value="${session.loginUser.memberNickname}"
                           readonly>
                    <textarea name="content" required></textarea>
                    <button>๋ฑ๋ก</button>
                </form>

                <!-- ๋ก๊ทธ์ธ X -->
                <p th:if="${session.loginUser == null}">
                    ๋ต๊ธ์ ์์ฑํ๋ค๋ฉด <a href="/login">๋ก๊ทธ์ธ</a>์ด ํ์ํฉ๋๋ค.
                </p>

            </details>
        </div>

        <!-- ์ ๋๊ธ ์์ฑ -->
        <h4>๋๊ธ ์์ฑ</h4>

        <!-- ๋ก๊ทธ์ธ O -->
        <form th:if="${session.loginUser != null}"
              th:action="@{/comment/write}" method="post">
            <input type="hidden" name="postId" th:value="${post.id}">
            <!-- ์์ฑ์ ๋๋ค์ ํ์ -->
            <input type="text"
                   th:value="${session.loginUser.memberNickname}"
                   readonly>
            <textarea name="content" required></textarea>
            <button>๋ฑ๋กํ๊ธฐ</button>
        </form>

        <!-- ๋ก๊ทธ์ธ X -->
        <p th:if="${session.loginUser == null}">
            ๋๊ธ์ ์์ฑํ๋ค๋ฉด <a href="/login">๋ก๊ทธ์ธ</a>์ด ํ์ํฉ๋๋ค.
        </p>

    </div>

</div>

</body>
</html>
