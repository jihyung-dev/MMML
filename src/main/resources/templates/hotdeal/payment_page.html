<!-- templates/hotdeal/payment_page.html -->
<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}"
      th:with="CONTENT_TITLE='결제 | Hotdeal'">
<head>
    <meta charset="utf-8"/>
    <title>결제 - Hotdeal</title>
    <link layout:fragment="css" th:href="@{/css/item-detail.css}" rel="stylesheet"/>
    <style>
        .payment-card { max-width: 900px; margin: 2rem auto; }
        .summary-row { display:flex; justify-content:space-between; align-items:center; padding:0.75rem 0; }
        .muted-small { font-size:0.9rem; color:#6c757d; }
        .pay-btn { min-width: 240px; }
    </style>
    <script defer src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script defer th:src="@{/js/payment/requestPay.js}"></script>
</head>

<body>
<div layout:fragment="content" class="container">

    <div class="payment-card card shadow-sm">
        <div class="card-body">
            <h4 class="card-title mb-3">결제 정보 확인</h4>

            <div th:if="${order != null}">

                <input type="hidden" id="orderId" th:value="${order.id}">
                <input type="hidden" id="merchantUid" th:value="${order.merchantUid}">
                <input type="hidden" id="amount" th:value="${order.totalAmount}">
                <input type="hidden" id="buyerId" th:value="${session.loginUser != null ? session.loginUser.memberId : ''}">

                <div class="mb-3">
                    <small class="muted-small">주문번호</small>
                    <div class="fw-bold" th:text="${order != null ? '#' + order.id : 'order-unknown'}">order-xxxxxxxx-xxxx</div>
                </div>

                <div class="mb-3">
                    <small class="muted-small">상품 / 주문 요약</small>
                    <div class="border rounded p-3 bg-light">
                        <div class="summary-row">
                            <div>
                                <div th:text="${order.Id != null ? '주문 #' + order.Id : ''}">주문 #123</div>
                                <div class="muted-small"
                                     th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'yyyy-MM-dd') : ''}">
                                    2025-12-04 16:00
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="h5 text-danger" th:text="${#numbers.formatInteger(amount, 3, 'COMMA')} + '원'">10,000원</div>
                                <div class="muted-small">최종 결제 금액</div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <ul class="list-group">
                                <li th:each="oi : ${order.orderItems}"
                                    class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <!-- item 객체가 null인지 안전하게 체크 -->
                                        <div th:text="${oi.item != null ? oi.item.itemName : '상품명 없음'}">상품명</div>

                                        <!-- 옵션 표시 (option이 존재하면 보여주기) -->
                                        <small class="muted-small"
                                               th:if="${oi.option != null}"
                                               th:text="'옵션: ' + oi.option.optionType + ' ' + oi.option.optionValue">옵션명</small>
                                    </div>

                                    <div class="text-end">
                                        <!-- 가격 포맷(콤마) — BigDecimal의 longValue()를 사용해 포맷 -->
                                        <div th:text="${#numbers.formatInteger(oi.price.longValue(), 3, 'COMMA')} + '원'">9,900원</div>
                                        <small class="muted-small" th:text="'수량: ' + oi.qty">수량: 1</small>
                                    </div>
                                </li>

                                <!-- orderItems 비어있을 때의 대체 UI -->
                                <li th:if="${order.orderItems == null or #lists.isEmpty(order.orderItems)}"
                                    class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>상품이 없습니다.</div>
                                        <div th:text="${#numbers.formatInteger(amount, 3, 'COMMA')} + '원'">0원</div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="muted-small">결제 수단</small>
                    <div class="mt-2 d-flex gap-2">
                        <button id="payBtn" class="btn btn-primary pay-btn">결제하기</button>
                        <button id="modifyBtn" class="btn btn-warning">주문 수정</button>
                        <button id="cancelBtn" class="btn btn-outline-secondary">주문 취소</button>
                    </div>
                </div>

                <div class="mt-3 alert alert-light small">
                    <strong>유의사항:</strong>
                    <ul class="mb-0">
                        <li>결제 진행 중에는 브라우저를 닫지 마세요.</li>
                        <li>결제가 완료되면 자동으로 결제 완료 페이지로 이동합니다.</li>
                    </ul>
                </div>
            </div>

            <div th:unless="${order != null}" class="text-center py-4">
                <p class="text-muted">유효한 주문 정보가 없습니다. 다시 시도해 주세요.</p>
                <a th:href="@{/hotdeal}" class="btn btn-outline-primary">핫딜 목록으로</a>
            </div>
        </div>
    </div>

</div>

<!-- 안전한 JS 인라인 사용: th:inline="javascript" -->
<script th:inline="javascript" layout:fragment="script">
    /*<![CDATA[*/
    var orderId = /*[[${order.id} ?: 0]]*/ 0;
    var merchantUid = /*[[${merchantUid} ?: 'order-unknown']]*/ 'order-unknown';
    var amount = /*[[${amount} ?: 0]]*/ 0;

    document.addEventListener('DOMContentLoaded', function () {
        var payBtn = document.getElementById('payBtn');
        var cancelBtn = document.getElementById('cancelBtn');


        if (payBtn) {
            payBtn.addEventListener('click', function () {

                // 💡 1. Hidden Input 필드에서 값 가져오기
                var orderId = document.getElementById('orderId').value;
                var merchantUid = document.getElementById('merchantUid').value;
                var amount = document.getElementById('amount').value;
                var buyerId = document.getElementById('buyerId').value; //구매자 정보는 hidden 필드에서 가져오기.


                if (!confirm('총 ' + amount + '원을 결제하시겠습니까?')) return;
                // 실제 PG 연동 스크립트로 대체하세요.
                //window.location.href = /*[[@{/hotdeal/order/success}]]*/ '/hotdeal/order/success';
                startPayment(orderId, merchantUid, amount, buyerId);
            });
        }

        // 주문 취소 버튼은 PENDING 상태 주문 취소 로직으로 연
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function () {
                if (!confirm('주문을 취소하시겠습니까?')) return;
                //window.location.href = /*[[@{/hotdeal}]]*/ '/hotdeal';
                window.location.href = /*[[@{'/hotdeal/order/cancel?merchant_uid=' + __${merchantUid}__}]]*/ '/hotdeal/order/cancel?merchant_uid=';
            });
        }

        //주문 수정
        var modifyBtn = document.getElementById('modifyBtn');

        if (modifyBtn){
            modifyBtn.addEventListener('click', function (){
                var merchantUid = document.getElementById('merchantUid').value;
                var orderId = document.getElementById('orderId').value;

                if (!confirm("주문을 수정하시겠습니까?")) return;

                // 💡 [핵심] 수정 처리 함수 호출
                handleOrderModification(merchantUid, orderId);
            });
        }
    });
    /*]]>*/
</script>

</body>
</html>
