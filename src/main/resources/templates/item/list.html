<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">
<head>
    <!-- í”„ë¡œì íŠ¸ CSS -->
    <th:block layout:fragment="css">
        <link rel="stylesheet" href="/css/item-list.css">
    </th:block>

</head>
<body>

<div layout:fragment="content">

<!--    main ë‚´ìš©, ë¡œê·¸ì¸ê´€ë ¨ìœ¼ë¡œ ìœ ì¶”ì¤‘ -->
<!--     ğŸ”¹ íŒë§¤ì ë“±ë¡ / íŒë§¤ì ìƒì„¸ / ë¡œê·¸ì¸ í›„ ìœ ë„ ë²„íŠ¼-->
    <div class="d-flex justify-content-end mb-3">

        <!-- 1) ë¹„ë¡œê·¸ì¸: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ìœ ë„ -->
        <a th:if="${session.loginUser == null}"
           th:href="@{/login}"
           class="btn btn-outline-secondary btn-sm">
            ë¡œê·¸ì¸ í›„ íŒë§¤ì ë“±ë¡
        </a>

        <!-- 2) ë¡œê·¸ì¸ í–ˆê³ , ì•„ì§ íŒë§¤ìê°€ ì•„ë‹Œ ê²½ìš°: íŒë§¤ì ë“±ë¡ (í™œì„±) -->
        <a th:if="${session.loginUser != null and (session.isSeller == null or session.isSeller == false)}"
           th:href="@{/seller/join}"
           class="btn btn-outline-primary btn-sm me-2">
            íŒë§¤ì ë“±ë¡
        </a>

        <!-- 3) ë¡œê·¸ì¸ í–ˆê³ , ì´ë¯¸ íŒë§¤ìì¸ ê²½ìš°: ìƒí’ˆ íŒë§¤ ë“±ë¡ -->
        <a th:if="${session.loginUser != null and session.isSeller == true}"
           th:href="@{/seller/item/new}"
           class="btn btn-success btn-sm">
            ìƒí’ˆ íŒë§¤ ë“±ë¡
        </a>
    </div>


    <!--    ë³‘í•© - hotdeal ë‚´ìš©ìœ¼ë¡œ  -->
    <!--    ì¹´í…Œê³ ë¦¬ ë²„íŠ¼-->
    <form th:action="@{/hotdeal}" method="get" class="d-flex mb-4">

        <!--             ìˆ¨ê²¨ì§„ í•„ë“œ/â‡’ í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ê°’ ìœ ì§€ -->
        <input type="hidden" name="categoryId" th:value="${param.categoryId}" />

        <!-- ì¹´í…Œê³ ë¦¬ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ -->
        <div class="category-wrap-overlay position-relative d-flex align-items-center" style="flex:1;">
            <!-- ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ (ì™¼ìª½) -->
            <div class="fade-overlay fade-left" aria-hidden="true"></div>

            <!--             ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ê·¸ë£¹ -->
            <!--            <div class="btn-group me-2" role="group">-->
            <div class="category-scroll" id="categoryScroll" role="tablist" aria-label="ì¹´í…Œê³ ë¦¬">
                <!--                ì „ì²´ë²„íŠ¼-->
                <a th:href="@{/hotdeal}"
                   th:classappend="${param.categoryId == null or param.categoryId[0] == ''} ? 'btn-primary' : 'btn-outline-secondary'"
                   class="btn btn-outline-secondary btn-sm mx-1">ì „ì²´</a>

                <!--             DBì—ì„œ ê°€ì ¸ì˜¨ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ë“¤ -->
                <!-- th:href="@{'/hotdeal'(categoryId=${c.categoryId}, q=${param.q})} â‡’ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë¡œ í•„í„° + ê²€ìƒ‰ì–´ ìœ ì§€-->
                <a th:each="c : ${categories}"
                   th:href="@{'/hotdeal'(categoryId=${c.categoryId}, q=${param.q})}"
                   th:text="${c.categoryName}"
                   th:classappend="${param.categoryId != null and param.categoryId[0]  == c.categoryId} ? 'btn-primary' : 'btn-outline-secondary'"
                   class="btn btn-outline-secondary btn-sm category-btn mx-1">
                </a>
            </div>


            <!-- ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ (ì˜¤ë¥¸ìª½) -->
            <div class="fade-overlay fade-right" aria-hidden="true"></div>

            <!-- ì™¼ìª½/ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ (SVG ì•„ì´ì½˜) -->
            <button type="button" class="cat-scroll-btn btn btn-light" id="catScrollLeft" aria-label="ì™¼ìª½ìœ¼ë¡œ ìŠ¤í¬ë¡¤" disabled>
                <!-- left SVG -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <button type="button" class="cat-scroll-btn btn btn-light" id="catScrollRight" aria-label="ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤í¬ë¡¤">
                <!-- right SVG -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

        </div>

        <!--        ê²€ìƒ‰ì°½-->
        <input type="text" name="q"
               th:value="${param.q}"
               class="form-control form-control-sm ms-2 search-input"
               placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        />
        <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
    </form>


    <!-- ì •ë ¬(ë“œë¡­ë‹¤ìš´) -->
    <div class="dropdown d-flex justify-content-end" id="sortDropdownWrap">
        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="sortDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
            ì •ë ¬:
            <!-- ì„œë²„ì—ì„œ currentSortLabel ë„˜ê²¨ì£¼ë©´ ìš°ì„  ì‚¬ìš©, ì•„ë‹ˆë©´ param.sort ë˜ëŠ” JSê°€ ì±„ì›€ -->
            <span th:text="${currentSortLabel != null ? currentSortLabel : 'ìµœì‹ ìˆœ'}"
                  id="sortDropdownLabel">ìµœì‹ ìˆœ</span>
        </button>

        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown" id="sortDropdownMenu">
            <li><a class="dropdown-item" th:href="@{'?'(page=0,sort='createdAt,desc')}">ìµœì‹ ìˆœ</a></li>
            <li><a class="dropdown-item" th:href="@{'?'(page=0,sort='itemSaleprice,asc')}">ë‚®ì€ ê°€ê²©</a></li>
            <li><a class="dropdown-item" th:href="@{'?'(page=0,sort='itemSaleprice,desc')}">ë†’ì€ ê°€ê²©</a></li>
            <li>
                <a class="dropdown-item"
                   th:href="@{/hotdeal(page=0, sort='popularityScore,desc', categoryId=${param.categoryId}, q=${param.q}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, status=${param.status})}">
                    ì¸ê¸°ë„ìˆœ
                </a>
            </li>
        </ul>
    </div>

    <div  class="d-flex justify-content-end py-2">
        <small th:text="'ì´ ' + ${itemPage.totalElements} + 'ê°œ'">ì´ 0ê°œ</small>
    </div>
    <div class="row g-3">
        <div class="col-12 col-sm-6 col-md-4 col-lg-3" th:each="item : ${itemPage.content}">
            <div class="card h-100 position-relative"> <a th:href="@{/hotdeal/{id}(id=${item.id})}" style="text-decoration:none;color:inherit;">

                <img th:src="${item.imageUrl != null ? item.imageUrl : '/img/no-image.png'}"
                     class="card-img-top"
                     alt="thumb"
                     style="height: 200px; object-fit: cover;"
                     onerror="this.src='/img/no-image.png'"/>

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-truncate" th:text="${item.itemName}">ìƒí’ˆëª…</h5>

                    <span class="badge bg-warning text-dark mb-2 align-self-start"
                          th:if="${item.saleEndAt != null}"
                          th:with="days=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDateTime).now(), item.saleEndAt)}"
                          th:text="${days == 0 ? 'D-DAY' : (days > 0 ? 'D-' + days : 'ì¢…ë£Œ')}">
        D-Day
    </span>

                    <p class="card-text mt-auto">
                        <strong th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + 'ì›'}">0ì›</strong>
                    </p>

                    <div class="text-muted small mt-1">
                        ì¡°íšŒ <span th:text="${item.viewCount}">0</span> Â·
                        ì¸ê¸° <span th:text="${item.popularityScore}">0</span>
                    </div>
                </div>
            </a>

                <button type="button"
                        class="btn btn-light position-absolute top-0 end-0 m-2 rounded-circle shadow-sm p-0 d-flex justify-content-center align-items-center"
                        style="width: 32px; height: 32px; z-index: 10;"
                        th:onclick="'toggleLike(this, ' + ${item.id} + ')'">

                    <i th:class="${item.isLiked} ? 'bi bi-heart-fill text-danger' : 'bi bi-heart'"
                       style="font-size: 1.2rem;">
                    </i>
                </button>

            </div>
        </div>
    </div>


<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
<div th:with="page=${itemPage.number}, last=${itemPage.totalPages}, sort=${itemPage.sort}, size=${param.size}" class="my-4 d-flex justify-content-center">
    <nav>
        <ul class="pagination">
            <li class="page-item" th:classappend="(${itemPage}==0 ? 'disabled')">
                <a class="page-link" th:href="@{'?'(page=0, size=${size})}">â‰ª</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(1, last)}"
                th:classappend="((${i}-1) == ${page}?'active')">
                <a class="page-link" th:href="@{'?'(page=${i}-1, size=${size})}" th:text="${i}"></a>
            </li>
            <li class="page-item" th:classappend="(${page} == (${last}-1) ? 'disabled')">
                <a class="page-link" th:href="@{'?'(page=${last}-1, size=${size})}">â‰«</a>
            </li>
        </ul>
    </nav>
</div>

</div>
<script layout:fragment="script">

        // ì°œí•˜ê¸° í† ê¸€ í•¨ìˆ˜
        function toggleLike(btn, itemId) {
        // 1. ì„œë²„ì— ì°œ í† ê¸€ ìš”ì²­ (POST)
        fetch(`/hotdeal/wishlist/${itemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 401) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    return null;
                }
                if (!response.ok) throw new Error("ì°œí•˜ê¸° ì‹¤íŒ¨");
                return response.json();
            })
            .then(data => {
                if (!data) return; // ì—ëŸ¬ ì‹œ ì¤‘ë‹¨

                // 2. ì„œë²„ ì‘ë‹µ(wished: true/false)ì— ë”°ë¼ ì•„ì´ì½˜ ë³€ê²½
                const icon = btn.querySelector('i');
                if (data.wished) {
                    // ì°œ ìƒíƒœê°€ ë¨ -> ê½‰ ì°¬ ë¹¨ê°„ í•˜íŠ¸ë¡œ ë³€ê²½
                    // ê¸°ì¡´ ë¹ˆ í•˜íŠ¸ í´ë˜ìŠ¤ ì œê±°
                    icon.classList.remove('bi-heart');
                    // ê½‰ ì°¬ í•˜íŠ¸ + ë¹¨ê°„ìƒ‰ ì¶”ê°€
                    icon.classList.add('bi-heart-fill', 'text-danger');
                } else {
                    // ì°œ ì·¨ì†Œë¨ -> ë¹ˆ í•˜íŠ¸ë¡œ ë³€ê²½
                    icon.classList.remove('bi-heart-fill', 'text-danger');
                    icon.classList.add('bi-heart');
                }
            })
            .catch(error => console.error("Error:", error));
    }

        (function(){ //ì •ë ¬ í‚¤ì›Œë“œ ë°”ë€ŒëŠ” js
            // 1) ì½˜ì†”ì— JS ì—ëŸ¬ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸ (ë””ë²„ê·¸ìš© ë¡œê·¸)
            try {
                // 2) URLì—ì„œ sort íŒŒë¼ë¯¸í„° ì½ê¸°
                function getParam(name) {
                    const url = new URL(window.location.href);
                    return url.searchParams.get(name);
                }
                const sortParam = getParam('sort');

                // 3) ë ˆì´ë¸” ì„ íƒ ë¡œì§ (ì„œë²„ê°€ ë„˜ê¸´ ê°’ì´ ì—†ì„ ë•Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì±„ì›€)
                const labelEl = document.getElementById('sortDropdownLabel');
                if (labelEl) {
                    if (!labelEl.textContent || labelEl.textContent.trim() === '' || labelEl.textContent.trim() === 'ìµœì‹ ìˆœ') {
                        // only override if server didn't explicitly set another label
                        if (sortParam && sortParam.includes('itemSaleprice,asc')) labelEl.textContent = 'ë‚®ì€ ê°€ê²©';
                        else if (sortParam && sortParam.includes('itemSaleprice,desc')) labelEl.textContent = 'ë†’ì€ ê°€ê²©';
                        else if (sortParam && sortParam.includes('popularityScore,desc')) labelEl.textContent = 'ì¸ê¸°ë„ìˆœ';
                        else labelEl.textContent = 'ìµœì‹ ìˆœ';
                    }
                }

                // 4) Bootstrap JSê°€ ë¡œë“œë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ ê°„ë‹¨í•œ í´ë°±ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ë™ì‘ ì œê³µ
                var dropdownToggle = document.getElementById('sortDropdown');
                var dropdownMenu = document.getElementById('sortDropdownMenu');
                if (dropdownToggle && dropdownMenu) {
                    var bootstrapLoaded = (typeof bootstrap !== 'undefined') && bootstrap.Dropdown;
                    if (!bootstrapLoaded) {
                        // í´ë°± í† ê¸€ (ê°„ë‹¨ êµ¬í˜„)
                        dropdownToggle.addEventListener('click', function(e){
                            e.stopPropagation();
                            var isShown = dropdownMenu.classList.contains('show');
                            if (isShown) {
                                dropdownMenu.classList.remove('show');
                                dropdownToggle.setAttribute('aria-expanded', 'false');
                            } else {
                                dropdownMenu.classList.add('show');
                                dropdownToggle.setAttribute('aria-expanded', 'true');
                            }
                        });
                        // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
                        document.addEventListener('click', function(){
                            if (dropdownMenu.classList.contains('show')) {
                                dropdownMenu.classList.remove('show');
                                dropdownToggle.setAttribute('aria-expanded','false');
                            }
                        });
                        // ESCë¡œ ë‹«ê¸°
                        document.addEventListener('keydown', function(e){
                            if (e.key === 'Escape' && dropdownMenu.classList.contains('show')) {
                                dropdownMenu.classList.remove('show');
                                dropdownToggle.setAttribute('aria-expanded','false');
                            }
                        });
                    } else {
                        // Bootstrapì´ ìˆë‹¤ë©´, JS ì—ëŸ¬ê°€ ì—†ëŠ”ì§€ í™•ì¸ (ê°œë°œì ì½˜ì†” ê¶Œì¥)
                        // (Bootstrapì´ ìë™ìœ¼ë¡œ ì‘ë™í•˜ë¯€ë¡œ ì¶”ê°€ ì„¤ì • ë¶ˆí•„ìš”)
                    }
                }
            } catch (err) {
                console.error('sort dropdown script error:', err);
            }
        })();

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>