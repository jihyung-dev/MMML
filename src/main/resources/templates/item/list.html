<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">

<head>
    <!-- 프로젝트 CSS -->
    <link  layout:fragment="css" th:href="@{/css/item-list.css}" rel="stylesheet"/>

    <style layout:fragment="css">
        .menu-link:hover {
            color: black;
            text-decoration: underline;
        }
    </style>

</head>
<body>

<div layout:fragment="content">

<!--    main 내용, 로그인관련으로 유추중 -->
<!--     🔹 판매자 등록 / 판매자 상세 / 로그인 후 유도 버튼-->
    <div class="d-flex justify-content-end mb-3">

        <!-- 1) 비로그인: 로그인 페이지로 유도 -->
        <a th:if="${session.loginUser == null}"
           th:href="@{/login}"
           class="btn btn-outline-secondary btn-sm">
            로그인 후 판매자 등록
        </a>

        <!-- 2) 로그인 했고, 아직 판매자가 아닌 경우: 판매자 등록 (활성) -->
        <a th:if="${session.loginUser != null and (session.isSeller == null or session.isSeller == false)}"
           th:href="@{/seller/join}"
           class="btn btn-outline-primary btn-sm me-2">
            판매자 등록
        </a>

        <!-- 3) 로그인 했고, 이미 판매자인 경우: 상품 판매 등록 -->
        <a th:if="${session.loginUser != null and session.isSeller == true}"
           th:href="@{/seller/item/new}"
           class="btn btn-success btn-sm">
            상품 판매 등록
        </a>
    </div>


    <!--    병합 - hotdeal 내용으로  -->
    <!--    카테고리 버튼-->
    <form th:action="@{/hotdeal}" method="get" class="d-flex mb-4">

        <!--             숨겨진 필드/⇒ 현재 선택된 카테고리 값 유지 -->
        <input type="hidden" name="categoryId" th:value="${param.categoryId}" />

        <!-- 카테고리 스크롤 컨테이너 -->
        <div class="category-wrap-overlay position-relative d-flex align-items-center" style="flex:1;">
            <!-- 그라데이션 오버레이 (왼쪽) -->
            <div class="fade-overlay fade-left" aria-hidden="true"></div>

            <!--             카테고리 버튼 그룹 -->
            <!--            <div class="btn-group me-2" role="group">-->
            <div class="category-scroll" id="categoryScroll" role="tablist" aria-label="카테고리">
                <!--                전체버튼-->
                <a th:href="@{/hotdeal}"
                   th:classappend="${param.categoryId == null or param.categoryId[0] == ''} ? 'btn-primary' : 'btn-outline-secondary'"
                   class="btn btn-outline-secondary btn-sm mx-1">전체</a>

                <!--             DB에서 가져온 카테고리 버튼들 -->
                <!-- th:href="@{'/hotdeal'(categoryId=${c.categoryId}, q=${param.q})} ⇒ 카테고리 버튼 클릭 시 해당 카테고리로 필터 + 검색어 유지-->
                <a th:each="c : ${categories}"
                   th:href="@{'/hotdeal'(categoryId=${c.categoryId}, q=${param.q})}"
                   th:text="${c.categoryName}"
                   th:classappend="${param.categoryId != null and param.categoryId[0]  == c.categoryId} ? 'btn-primary' : 'btn-outline-secondary'"
                   class="btn btn-outline-secondary btn-sm category-btn mx-1">
                </a>
            </div>


            <!-- 그라데이션 오버레이 (오른쪽) -->
            <div class="fade-overlay fade-right" aria-hidden="true"></div>

            <!-- 왼쪽/오른쪽 화살표 (SVG 아이콘) -->
            <button type="button" class="cat-scroll-btn btn btn-light" id="catScrollLeft" aria-label="왼쪽으로 스크롤" disabled>
                <!-- left SVG -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <button type="button" class="cat-scroll-btn btn btn-light" id="catScrollRight" aria-label="오른쪽으로 스크롤">
                <!-- right SVG -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

        </div>

        <!--        검색창-->
        <input type="text" name="q"
               th:value="${param.q}"
               class="form-control form-control-sm ms-2 search-input"
               placeholder="검색어를 입력하세요"
        />
        <button type="submit" class="btn btn-primary">검색</button>
    </form>


    <!-- 정렬(드롭다운) -->
<!-- 서버로는 ?sort=NEWEST, PRICE_ASC, PRICE_DESC, POPULAR 등으로 전달 -->
<div class="dropdown d-flex justify-content-end">
    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="sortDropdown"
            data-bs-toggle="dropdown" aria-expanded="false">
        정렬: <span th:text="${currentSortLabel != null ? currentSortLabel : '최신순'}">최신순</span>
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
        <li><a class="dropdown-item" th:href="@{'?'(page=0,sort='createdAt,desc')}">최신순</a></li>
        <li><a class="dropdown-item" th:href="@{'?'(page=0,sort='itemSaleprice,asc')}">낮은 가격</a></li>
        <li><a class="dropdown-item" th:href="@{'?'(page=0,sort='itemSaleprice,desc')}">높은 가격</a></li>
        <!-- 수정필요                <li><a class="dropdown-item" th:href="@{'?'(page=0,sort='createdAt,desc')}">인기도</a></li>-->

        <!-- 인기도 추가 -->
        <li>
            <a class="dropdown-item"
               th:href="@{/hotdeal(page=0, sort='popularityScore,desc', categoryId=${param.categoryId}, q=${param.q}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, status=${param.status})}">
                인기도순
            </a>
        </li>
    </ul>
</div>

    <div  class="d-flex justify-content-end py-2">
        <small th:text="'총 ' + ${itemPage.totalElements} + '개'">총 0개</small>
    </div>
    <div class="row g-3">
        <div class="col-12 col-sm-6 col-md-4 col-lg-3" th:each="item : ${itemPage.content}">
            <div class="card h-100 position-relative"> <a th:href="@{/hotdeal/{id}(id=${item.id})}" style="text-decoration:none;color:inherit;">

                <img th:src="${item.imageUrl != null ? item.imageUrl : '/img/no-image.png'}"
                     class="card-img-top"
                     alt="thumb"
                     style="height: 200px; object-fit: cover;"
                     onerror="this.src='/img/no-image.png'"/>

                <div class="card-body d-flex flex-column"  th:each="item, stat : ${hotdealItems}">
                    <h5 class="card-title text-truncate" th:text="${item.itemName}">상품명</h5>
                    <span th:text="${hotdealDDays[stat.index] == 0 ? 'D-DAY' : 'D-' + hotdealDDays[stat.index]}">D-day</span>
                    <p class="card-text mt-auto">
                        <strong th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + '원'}">0원</strong>
                    </p>

                </div>
            </a>

                <button type="button"
                        class="btn btn-light position-absolute top-0 end-0 m-2 rounded-circle shadow-sm p-0 d-flex justify-content-center align-items-center"
                        style="width: 32px; height: 32px; z-index: 10;"
                        th:onclick="'toggleLike(this, ' + ${item.id} + ')'">

                    <i th:class="${item.isLiked} ? 'bi bi-heart-fill text-danger' : 'bi bi-heart'"
                       style="font-size: 1.2rem;">
                    </i>
                </button>

            </div>
        </div>
    </div>


<!-- 페이지네이션 -->
<div th:with="page=${itemPage.number}, last=${itemPage.totalPages}, sort=${itemPage.sort}, size=${param.size}" class="my-4 d-flex justify-content-center">
    <nav>
        <ul class="pagination">
            <li class="page-item" th:classappend="(${itemPage}==0 ? 'disabled')">
                <a class="page-link" th:href="@{'?'(page=0, size=${size})}">≪</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(1, last)}"
                th:classappend="((${i}-1) == ${page}?'active')">
                <a class="page-link" th:href="@{'?'(page=${i}-1, size=${size})}" th:text="${i}"></a>
            </li>
            <li class="page-item" th:classappend="(${page} == (${last}-1) ? 'disabled')">
                <a class="page-link" th:href="@{'?'(page=${last}-1, size=${size})}">≫</a>
            </li>
        </ul>
    </nav>
</div>

</div>
<script layout:fragment="script">

        // 찜하기 토글 함수
        function toggleLike(btn, itemId) {
        // 1. 서버에 찜 토글 요청 (POST)
        fetch(`/hotdeal/wishlist/${itemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 401) {
                    alert("로그인이 필요합니다.");
                    window.location.href = "/login"; // 로그인 페이지로 이동
                    return null;
                }
                if (!response.ok) throw new Error("찜하기 실패");
                return response.json();
            })
            .then(data => {
                if (!data) return; // 에러 시 중단

                // 2. 서버 응답(wished: true/false)에 따라 아이콘 변경
                const icon = btn.querySelector('i');
                if (data.wished) {
                    // 찜 상태가 됨 -> 꽉 찬 빨간 하트로 변경
                    // 기존 빈 하트 클래스 제거
                    icon.classList.remove('bi-heart');
                    // 꽉 찬 하트 + 빨간색 추가
                    icon.classList.add('bi-heart-fill', 'text-danger');
                } else {
                    // 찜 취소됨 -> 빈 하트로 변경
                    icon.classList.remove('bi-heart-fill', 'text-danger');
                    icon.classList.add('bi-heart');
                }
            })
            .catch(error => console.error("Error:", error));
    }


</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>