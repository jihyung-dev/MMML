<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${item.itemName} + ' | Hotdeal'">ìƒí’ˆ ìƒì„¸ | Hotdeal</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- í”„ë¡œì íŠ¸ CSS -->
    <link th:href="@{/css/item-detail.css}" rel="stylesheet"/>

</head>
<!--<body class="bg-light">-->
<body>

<!--<div class="container py-4">-->
<div class="container mt-4">
<!-- ìƒë‹¨ ë©”ë‰´ / ë’¤ë¡œê°€ê¸° -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <a th:href="@{/hotdeal}" class="btn btn-outline-secondary btn-sm">â† ëª©ë¡ìœ¼ë¡œ</a>
        </div>
        <div class="d-flex gap-2">
            <a th:href="@{/mypage}" class="btn btn-outline-secondary btn-sm">ë§ˆì´í˜ì´ì§€</a>
            <a th:href="@{/hotdeal}" class="btn btn-primary btn-sm">í•«ë”œ í™ˆ</a>
        </div>
    </div>

    <div class="row g-4">
        <!-- ì´ë¯¸ì§€ / ìºëŸ¬ì…€ -->
        <div class="col-12 col-lg-6">
            <div th:if="${item.images != null and #lists.size(item.images) > 0}">
                <div id="itemCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div th:each="img, idx : ${item.images}"
                             th:classappend="${idx.index == 0} ? 'carousel-item active' : 'carousel-item'">
                            <img th:src="${img.imageUrl}" th:alt="${item.itemName}" class="d-block w-100 thumb"
                                 onerror="this.onerror=null;this.src='/img/no-image.png'"/>
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#itemCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#itemCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
            <!-- imagesê°€ ìˆì„ ë•Œë§Œ ë°˜ë³µ -->
            <th:block th:if="${item.images != null}">
                <div th:each="img : ${item.images}">
                    <img th:src="@{${img.imageUrl}}" />
                </div>
            </th:block>
            <div th:if="${item.images == null or #lists.size(item.images) == 0}" class="no-image">
                ì´ë¯¸ì§€ ì—†ìŒ
            </div>
        </div>

        <!-- ìƒí’ˆ ì •ë³´ / ì˜µì…˜ -->
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-body">
                    <!-- ìƒí’ˆ ì´ë¦„ -->
                    <h3 class="card-title" th:text="${item.itemName}">ìƒí’ˆëª…</h3>

                    <!-- ê°€ê²© í‘œì‹œ -->
                    <div class="mb-2">
                        <!-- ì›ë˜ ê°€ê²©: ìˆì„ ë•Œë§Œ ë³´ì—¬ì¤Œ, ì·¨ì†Œì„  í‘œì‹œ -->
                        <span class="original-price text-muted text-decoration-line-through"
                              th:if="${item.originalPrice != null}"
                              th:text="${item.formattedOriginalPrice}">0ì›</span>

                        <!-- í˜„ì¬ ê°€ê²©(ì„¸ì¼ ê°€ê²©): í•­ìƒ ë³´ì—¬ì¤Œ, ê°•ì¡° í‘œì‹œ -->
                        <span class="price-strong text-danger ms-2"
                              th:text="${item.formattedPrice}">0ì›</span>
                    </div>

                    <div class="mb-2 text-muted">
                        ì¡°íšŒìˆ˜: <span th:text="${item.viewCount}">0</span>
                        &nbsp;Â·&nbsp; ì¸ê¸°ë„: <span th:text="${item.popularityScore}">0</span>
                    </div>

                    <hr/>

                    <!-- ì˜µì…˜ ì„ íƒ (ë‘ ê°€ì§€ ì²˜ë¦¬: optionGroups ê°€ ìˆì„ ë•Œ -> ì—¬ëŸ¬ select, ì—†ì„ ë•Œ -> single selectë¡œ ëª¨ë“  ì˜µì…˜ ë…¸ì¶œ) -->
                    <form id="purchaseForm" th:action="@{/hotdeal/order}" method="post" class="mb-3">
<!--                    <form id="purchaseForm" action="#" method="post" class="mb-3">-->
                        <input type="hidden" name="itemId" th:value="${item.id}"/>

                        <!--fallback: optionGroups ê°€ ì—†ì„ ë•Œ (ë‹¨ì¼ selectì— ëª¨ë“  ì˜µì…˜ì„ ë…¸ì¶œ) -->
                        <div>
                            <div class="mb-2">
                                <div class="option-label">ì˜µì…˜</div>
                                <select class="form-select single-option" name="selectedOption">
                                    <option value="" style="color: #ccc">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option th:each="opt : ${item.hotdealOptions}"
                                            th:value="${opt.id}"
                                            th:text="${opt.optionType + ' - ' + opt.optionValue + opt.formattedAdditionalPrice}"
                                            th:data-additional-price="${opt.additionalPrice}"
                                            th:data-stock="${opt.stock}"
                                            th:data-option-type="${opt.optionType}"
                                            th:data-option-value="${opt.optionValue}"></option>
                                </select>
                            </div>
                        </div>

                        <!-- ìˆ˜ëŸ‰ -->
                        <div class="mb-3 d-flex align-items-center gap-2">
                            <label class="option-label mb-0">ìˆ˜ëŸ‰</label>
                            <input id="qtyInput" name="quantity" type="number" min="1" value="1" class="form-control" style="width:100px;" th:max="${item.hotdealOptions != null and #lists.size(item.hotdealOptions)>0 ? item.hotdealOptions[0].stock : '1'}"/>
                                                                                                                                            <!--â””â”€ ìˆ˜ëŸ‰ ì„ íƒ ë‚¨ì€ì¬ê³  ë„˜ì–´ê°€ì§€ ëª»í•˜ê²Œ í•´ë‘ .-->
                            <div class="ms-3 text-muted">ë‚¨ì€ì¬ê³ :
                                <span id="stockDisplay" th:text="${item.hotdealOptions != null and #lists.size(item.hotdealOptions)>0 ? item.hotdealOptions[0].stock : 'â€”'}">â€”</span>
                            </div>
                        </div>

                        <!-- ì„ íƒëœ ì¶”ê°€ê¸ˆì•¡ / ì´í•© ë³´ì—¬ì£¼ê¸° -->
                        <div class="mb-3">
                            <small class="text-muted">ì¶”ê°€ê¸ˆì•¡: <span id="additionalPrice">0ì›</span></small>
                            <div>
                                ì´ ì˜ˆìƒê²°ì œê¸ˆì•¡: <strong id="totalPrice" class="price-strong" th:text="${item.formattedPrice}">0ì›</strong>
                            </div>
                        </div>

                        <!-- ë²„íŠ¼ -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn" id="wishBtn"
                                    th:data-item-id="${item.id}"
                                    th:data-is-wished="${isWished}"
                                    th:classappend="${isWished} ? 'btn-danger' : 'btn-outline-primary'">
                                <span th:text="${isWished} ? 'â™¡ ì°œ ì·¨ì†Œ':'â™¥ ì°œí•˜ê¸°'"></span></button>
                            <button type="submit" class="btn btn-success" id="buyBtn">ë°”ë¡œêµ¬ë§¤</button>
                            <button type="button" class="btn btn-primary" id="cartBtn">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                        </div>
                    </form>

                    <hr/>

                    <!-- íŒë§¤ì ì •ë³´ -->
                    <div class="seller-box mt-3">
                        <div><strong>íŒë§¤ì</strong></div>
                        <div th:if="${item.seller != null}">
                            ì‚¬ì—…ìë²ˆí˜¸: <span th:text="${item.seller.bizNo}">000-00-00000</span><br/>
                            ì—…ì¢…: <span th:text="${item.seller.bizType}">ì—…ì¢…</span>
                        </div>
                        <div th:if="${item.seller == null}" class="text-muted">
                            íŒë§¤ì ì •ë³´ ì—†ìŒ
                        </div>
                    </div>

                </div>
            </div>

            <!-- ìƒì„¸ ì„¤ëª… (ê°„ë‹¨) -->
            <div class="card mt-3">
                <div class="card-body">
                    <h5>ìƒí’ˆ ìƒì„¸ì •ë³´</h5>
                    <div th:utext="${item.description != null}">
                        <p th:utext="${item.description}">ìƒì„¸ ì„¤ëª… ì˜ì—­</p>
                    </div>
                    <div th:unless="${item.description != null}" class="text-muted">ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /* ì˜µì…˜ ì„ íƒ -> ì¶”ê°€ê¸ˆì•¡ / ì¬ê³  / ì´ì•¡ ì—…ë°ì´íŠ¸ í•˜ëŠ” ê°„ë‹¨ JS
       (ì„œë²„ì—ì„œ í¬ë§·ëœ base price ë¬¸ìì—´(item.formattedPrice)ì„ ë³´ë‚´ì£¼ëŠ” ê²ƒì„ ê°€ì •)
       ì•„ë˜ëŠ” ê°€ê²© ê³„ì‚°ì˜ ì˜ˆì‹œ ë¡œì§ì…ë‹ˆë‹¤. ì‹¤ì œ ìˆ«ì ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” ì„œë²„ì—ì„œ basePrice(Number)ë„ ì£¼ëŠ”ê²Œ í¸í•©ë‹ˆë‹¤.
    */
    (function(){
        const currencyFmt = (num) => num ? String(num).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + 'ì›' : '0ì›';
        const parsePrice = txt => txt ? Number(String(txt).replace(/[^0-9.-]+/g,""))||0 : 0;

        const basePriceText = document.querySelector('.price-strong').innerText || '0ì›';
        const basePrice = parsePrice(basePriceText);

        const additionalPriceEl = document.getElementById('additionalPrice');
        const totalPriceEl = document.getElementById('totalPrice');
        const stockDisplay = document.getElementById('stockDisplay');
        const qtyInput = document.getElementById('qtyInput');

        const setAmounts = (addPrice, stock) => {
            additionalPriceEl.innerText = currencyFmt(addPrice);
            const qty = Number(qtyInput.value) || 1;
            totalPriceEl.innerText = currencyFmt((basePrice + addPrice) * qty);
            if(stock !== undefined && stock !== null) stockDisplay.innerText = stock;
        };

        const optionSelects = document.querySelectorAll('.option-select');
        if(optionSelects.length>0){
            optionSelects.forEach(sel=>{
                sel.addEventListener('change',()=>{
                    let sumAdd=0,minStock=null;
                    optionSelects.forEach(s=>{
                        const opt = s.options[s.selectedIndex];
                        if(opt && opt.dataset){
                            const ap = parseInt(opt.dataset.additionalPrice||0);
                            const st = opt.dataset.stock ? parseInt(opt.dataset.stock) : null;
                            sumAdd += ap||0;
                            if(st!==null) minStock = minStock===null?st:Math.min(minStock,st);
                        }
                    });
                    setAmounts(sumAdd,minStock);
                });
            });
        }

        const singleOption = document.querySelector('.single-option');
        if(singleOption){
            singleOption.addEventListener('change',()=>{
                const opt = singleOption.options[singleOption.selectedIndex];
                const ap = parseInt(opt.dataset.additionalPrice||0);
                const st = opt.dataset.stock ? parseInt(opt.dataset.stock):null;
                setAmounts(ap||0,st);
            });
        }

        qtyInput.addEventListener('input', ()=>{
            const add = parsePrice(additionalPriceEl.innerText);
            setAmounts(add, stockDisplay.innerText);
        });

        if(singleOption && singleOption.selectedIndex>0) singleOption.dispatchEvent(new Event('change'));
        else if(optionSelects.length>0) optionSelects[0].dispatchEvent(new Event('change'));
        else setAmounts(0,null);

        document.getElementById('cartBtn').addEventListener('click',()=>alert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì˜ˆì‹œ'));
        // document.getElementById('wishBtn').addEventListener('click',()=>alert('ì°œí•˜ê¸° ì˜ˆì‹œ'));
        document.addEventListener('DOMContentLoaded', function() {
            const wishBtn = document.getElementById('wishBtn');

            // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            wishBtn.addEventListener('click', function() {
                const itemId = this.getAttribute('data-item-id');
                let isWished = this.getAttribute('data-is-wished') === 'true'; // í˜„ì¬ ìƒíƒœ

                // ì°œ ìƒíƒœì— ë”°ë¼ ìš”ì²­í•  URL ë° ë©”ì„œë“œ ê²°ì •
                const url = `/hotdeal/wishlist/${itemId}`;
                const method = isWished ? 'DELETE' : 'POST'; // í˜„ì¬ ì°œ ìƒíƒœë©´ DELETE(ì·¨ì†Œ), ì•„ë‹ˆë©´ POST(ë“±ë¡)

                // 1. AJAX ìš”ì²­ (Fetch API ì‚¬ìš©)
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                        // CSRF í† í° í•„ìš” ì‹œ ì—¬ê¸°ì— ì¶”ê°€
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            // ì„œë²„ì—ì„œ ì˜¤ë¥˜ ì‘ë‹µì´ ì˜¨ ê²½ìš°
                            throw new Error('ì„œë²„ ìš”ì²­ ì‹¤íŒ¨');
                        }
                        // 2. ìš”ì²­ ì„±ê³µ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                        isWished = !isWished; // ìƒíƒœ ë°˜ì „

                        // 3. HTML ìš”ì†Œ ì†ì„± ë° í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
                        this.setAttribute('data-is-wished', isWished);

                        if (isWished) {
                            this.classList.remove('btn-outline-primary');
                            this.classList.add('btn-danger');
                            this.querySelector('span').textContent = 'â¤ï¸ ì°œ ì·¨ì†Œ';
                        } else {
                            this.classList.remove('btn-danger');
                            this.classList.add('btn-outline-primary');
                            this.querySelector('span').textContent = 'ğŸ¤ ì°œí•˜ê¸°';
                        }
                    })
                    .catch(error => {
                        console.error('ì°œí•˜ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                        alert('ì°œí•˜ê¸°/ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        });

        document.getElementById('purchaseForm').addEventListener('submit', ev=>{
            const requiredSelects = document.querySelectorAll('.option-select, .single-option');
            for(const s of requiredSelects){
                if(s.value===''){ ev.preventDefault(); alert('ì˜µì…˜ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'); s.focus(); return false;}
            }
            const stockVal = parseInt(stockDisplay.innerText);
            const qty = Number(qtyInput.value)||1;
            if(!isNaN(stockVal) && stockVal<qty){ ev.preventDefault(); alert('ì„ íƒí•œ ìˆ˜ëŸ‰ì´ ì¬ê³ ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤.'); return false;}
        });

    })();
</script>

</body>
</html>