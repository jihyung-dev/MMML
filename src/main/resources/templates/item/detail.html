<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}"
      th:with="CONTENT_TITLE=${item.itemName} + ' | Hotdeal'">
<head>
    <!-- 프로젝트 CSS -->
    <link  layout:fragment="css" th:href="@{/css/item-detail.css}" rel="stylesheet"/>
</head>

<!--<body class="bg-light">-->
<body>

<!--<div class="container py-4">-->
<div layout:fragment="content" class="mt-4">
<!-- 상단 메뉴 / 뒤로가기 -->
    <!--<div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <a th:href="@{/hotdeal}" class="btn btn-outline-secondary btn-sm">← 목록으로</a>
        </div>
        <div class="d-flex gap-2">
            <a th:href="@{/mypage}" class="btn btn-outline-secondary btn-sm">마이페이지</a>
            <a th:href="@{/hotdeal}" class="btn btn-primary btn-sm">핫딜 홈</a>
        </div>
    </div>--> <!--나중에 쓸 일 없으면 삭제하겠음-->

    <div class="row g-4">
        <!-- 이미지 / 캐러셀 -->
        <div class="col-12 col-lg-6">
            <div th:if="${item.images != null and #lists.size(item.images) > 0}">
                <div id="itemCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div th:each="img, idx : ${item.images}"
                             th:classappend="${idx.index == 0} ? 'carousel-item active' : 'carousel-item'">
                            <img th:src="${img.imageUrl}" th:alt="${item.itemName}" class="d-block w-100 thumb"
                                 onerror="this.onerror=null;this.src='/img/no-image.png'"/>
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#itemCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#itemCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
            <!-- images가 있을 때만 반복 -->
            <th:block th:if="${item.images != null}">
                <div th:each="img : ${item.images}">
                    <img th:src="@{${img.imageUrl}}" />
                </div>
            </th:block>
            <div th:if="${item.images == null or #lists.size(item.images) == 0}" class="no-image">
                이미지 없음
            </div>
        </div>

        <!-- 상품 정보 / 옵션 -->
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-body">
                    <!-- 상품 이름 -->
                    <h3 class="card-title" th:text="${item.itemName}">상품명</h3>

                    <!-- 가격 표시 -->
                    <div class="mb-2">
                        <!-- 원래 가격: 있을 때만 보여줌, 취소선 표시 -->
                        <span class="original-price text-muted text-decoration-line-through"
                              th:if="${item.originalPrice != null}"
                              th:text="${item.formattedOriginalPrice}">0원</span>

                        <!-- 현재 가격(세일 가격): 항상 보여줌, 강조 표시 -->
                        <span class="price-strong text-danger ms-2"
                              th:text="${item.formattedPrice}">0원</span>
                    </div>

                    <div class="mb-2 text-muted">
                        조회수: <span th:text="${item.viewCount}">0</span>
                        &nbsp;·&nbsp; 인기도: <span th:text="${item.popularityScore}">0</span>
                    </div>

                    <hr/>

                    <!-- 옵션 선택 (두 가지 처리: optionGroups 가 있을 때 -> 여러 select, 없을 때 -> single select로 모든 옵션 노출) -->
                    <form id="purchaseForm" th:action="@{/hotdeal/order}" method="post" class="mb-3">
<!--                    <form id="purchaseForm" action="#" method="post" class="mb-3">-->
                        <input type="hidden" name="itemId" th:value="${item.id}"/>

                        <!--fallback: optionGroups 가 없을 때 (단일 select에 모든 옵션을 노출) -->
                        <div>
                            <div class="mb-2">
                                <div class="option-label">옵션</div>
                                <select class="form-select single-option" name="selectedOption">
                                    <option value="" style="color: #ccc">선택하세요</option>
                                    <option th:each="opt : ${item.hotdealOptions}"
                                            th:value="${opt.id}"
                                            th:text="${opt.optionType + ' - ' + opt.optionValue + opt.formattedAdditionalPrice}"
                                            th:data-additional-price="${opt.additionalPrice}"
                                            th:data-stock="${opt.stock}"
                                            th:data-option-type="${opt.optionType}"
                                            th:data-option-value="${opt.optionValue}"></option>
                                </select>
                            </div>
                        </div>

                        <!-- 수량 -->
                        <div class="mb-3 d-flex align-items-center gap-2">
                            <label class="option-label mb-0">수량</label>
                            <input id="qtyInput" name="quantity" type="number" min="1" value="1" class="form-control" style="width:100px;" th:max="${item.hotdealOptions != null and #lists.size(item.hotdealOptions)>0 ? item.hotdealOptions[0].stock : '1'}"/>
                                                                                                                                            <!--└─ 수량 선택 남은재고 넘어가지 못하게 해둠.-->
                            <div class="ms-3 text-muted">남은재고:
                                <span id="stockDisplay" th:text="${item.hotdealOptions != null and #lists.size(item.hotdealOptions)>0 ? item.hotdealOptions[0].stock : '—'}">—</span>
                            </div>
                        </div>

                        <!-- 선택된 추가금액 / 총합 보여주기 -->
                        <div class="mb-3">
                            <small class="text-muted">추가금액: <span id="additionalPrice">0원</span></small>
                            <div>
                                총 예상결제금액: <strong id="totalPrice" class="price-strong" th:text="${item.formattedPrice}">0원</strong>
                            </div>
                        </div>

                        <!-- 버튼 -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn" id="wishBtn"
                                    th:data-item-id="${item.id}"
                                    th:data-is-wished="${isWished}"
                                    th:classappend="${isWished} ? 'btn-danger' : 'btn-outline-primary'">
                                <span th:text="${isWished} ? '♡ 찜 취소':'♥ 찜하기'"></span></button>
                            <button type="submit" class="btn btn-success" id="buyBtn">바로구매</button>
                            <button type="button" class="btn btn-primary" id="cartBtn">담기</button>
                        </div>
                    </form>

                    <hr/>

                    <!-- 판매자 정보 -->
                    <div class="seller-box mt-3">
                        <!-- 클릭하는 상단 영역 -->
                        <div class="seller-header" onclick="toggleSellerInfo()">
                            <a href="#seller-info" data-bs-toggle="collapse" style="text-decoration:none; color:inherit;">
                                <strong th:text="${item.seller != null ? item.seller.bizName : '판매자' }"></strong>
                                <span id="arrow">▼</span>
                            </a>
                        </div>

                        <!-- 접히는 영역 -->
                        <div id="seller-info" class="collapse" th:if="${item.seller != null}">
                            사업자번호: <span th:text="${item.seller.bizNo}"></span><br/>
                            업종: <span th:text="${item.seller.bizType}"></span>
                        </div>

                        <div th:if="${item.seller == null}" class="text-muted">
                            판매자 정보 없음
                        </div>
                    </div>

                </div>
            </div>

            <!-- 상세 설명 (간단) -->
            <div class="card mt-3">
                <div class="card-body">
                    <h5>상품 상세정보</h5>
                    <div th:utext="${item.description != null}">
                        <p th:utext="${item.description}">상세 설명 영역</p>
                    </div>
                    <div th:unless="${item.description != null}" class="text-muted">상세 설명이 없습니다.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script  layout:fragment="script">
    /*
        통합 스크립트
      - toggleSellerInfo: 전역 함수 (onclick으로 호출 가능)
      - 옵션/수량/총액 계산, 찜하기, 장바구니, 폼 검증 모두 DOMContentLoaded 안에서 안전하게 초기화
    */

    function toggleSellerInfo() {
        const info = document.getElementById("seller-info");
        const arrow = document.getElementById("arrow");
        if (!info || !arrow) return;

        if (info.classList.contains("collapsed")) {
            info.classList.remove("collapsed");
            info.classList.add("expanded");
            arrow.textContent = "▲";
        } else {
            info.classList.remove("expanded");
            info.classList.add("collapsed");
            arrow.textContent = "▼";
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        // 유틸
        const currencyFmt = (num) => {
            if (num === null || num === undefined) return '0원';
            const n = Number(num) || 0;
            return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + '원';
        };
        const parsePrice = txt => {
            if (!txt) return 0;
            return Number(String(txt).replace(/[^0-9.-]+/g,"")) || 0;
        };

        // 요소들 (존재여부 체크)
        const basePriceEl = document.querySelector('.price-strong');
        const basePriceText = basePriceEl ? basePriceEl.innerText : '0원';
        const basePrice = parsePrice(basePriceText);

        const additionalPriceEl = document.getElementById('additionalPrice');
        const totalPriceEl = document.getElementById('totalPrice');
        const stockDisplay = document.getElementById('stockDisplay');
        const qtyInput = document.getElementById('qtyInput');

        const setAmounts = (addPrice, stock) => {
            if (additionalPriceEl) additionalPriceEl.innerText = currencyFmt(addPrice);
            const qty = Number(qtyInput ? qtyInput.value : 1) || 1;
            if (totalPriceEl) totalPriceEl.innerText = currencyFmt((basePrice + (Number(addPrice)||0)) * qty);
            if (stockDisplay && (stock !== undefined && stock !== null)) stockDisplay.innerText = stock;
        };

        // 옵션(select) 처리
        const optionSelects = document.querySelectorAll('.option-select');
        if(optionSelects.length > 0){
            optionSelects.forEach(sel=>{
                sel.addEventListener('change',()=>{
                    let sumAdd = 0, minStock = null;
                    optionSelects.forEach(s=>{
                        const opt = s.options[s.selectedIndex];
                        if(opt && opt.dataset){
                            const ap = parseInt(opt.dataset.additionalPrice||0) || 0;
                            const st = opt.dataset.stock ? parseInt(opt.dataset.stock) : null;
                            sumAdd += ap;
                            if(st !== null) minStock = minStock === null ? st : Math.min(minStock, st);
                        }
                    });
                    setAmounts(sumAdd, minStock);
                });
            });
        }

        const singleOption = document.querySelector('.single-option');
        if(singleOption){
            singleOption.addEventListener('change',()=>{
                const opt = singleOption.options[singleOption.selectedIndex];
                const ap = opt && opt.dataset ? parseInt(opt.dataset.additionalPrice||0) : 0;
                const st = opt && opt.dataset && opt.dataset.stock ? parseInt(opt.dataset.stock) : null;
                setAmounts(ap||0, st);
            });
        }

        // 수량 변경 시 총액 갱신
        if(qtyInput){
            qtyInput.addEventListener('input', ()=>{
                const add = additionalPriceEl ? parsePrice(additionalPriceEl.innerText) : 0;
                setAmounts(add, stockDisplay ? stockDisplay.innerText : null);
            });
        }

        // 초기값 트리거
        if(singleOption && singleOption.selectedIndex > 0) singleOption.dispatchEvent(new Event('change'));
        else if(optionSelects.length > 0) optionSelects[0].dispatchEvent(new Event('change'));
        else setAmounts(0, stockDisplay ? stockDisplay.innerText : null);

        // 찜하기 로직 (안전 체크)
        const wishBtn = document.getElementById('wishBtn');
        if (wishBtn) {
            const itemId = wishBtn.dataset ? wishBtn.dataset.itemId : null;
            wishBtn.addEventListener('click', async (e) => {
                if (!itemId) {
                    alert('아이템 정보가 없습니다.');
                    return;
                }
                try {
                    const res = await fetch(`/hotdeal/wishlist/${itemId}`, { method: 'POST' });
                    if (!res.ok) {
                        if (res.status === 401) {
                            alert('로그인이 필요합니다. 로그인 후 사용해주세요.');
                            window.location.href = '/login';
                            return;
                        }
                        throw new Error('network response not ok');
                    }
                    const json = await res.json();
                    if (json) updateWishButton(wishBtn, json.wished);
                } catch(err) {
                    console.error('wish error', err);
                    alert('찜하기 처리 중 오류가 발생했습니다.');
                }
            });

            function updateWishButton(button, wished) {
                if (wished) {
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-primary', 'text-white');
                    button.innerText = '♥ 찜함';
                } else {
                    button.classList.remove('btn-primary', 'text-white', 'btn-danger');
                    button.classList.add('btn-outline-primary');
                    button.innerText = '♥ 찜하기';
                }
            }
        }

        // 장바구니 버튼 (예시)
        const cartBtn = document.getElementById('cartBtn');
        if(cartBtn){
            cartBtn.addEventListener('click', ()=> alert('장바구니 담기 예시'));
        }

        // 구매 폼 제출 검증
        const purchaseForm = document.getElementById('purchaseForm');
        if(purchaseForm){
            purchaseForm.addEventListener('submit', ev=>{
                const requiredSelects = document.querySelectorAll('.option-select, .single-option');
                for(const s of requiredSelects){
                    if(s && s.value === ''){
                        ev.preventDefault();
                        alert('옵션을 모두 선택해주세요.');
                        s.focus && s.focus();
                        return false;
                    }
                }
                const stockVal = stockDisplay ? parseInt(stockDisplay.innerText) : NaN;
                const qty = Number(qtyInput ? qtyInput.value : 1) || 1;
                if(!isNaN(stockVal) && stockVal < qty){
                    ev.preventDefault();
                    alert('선택한 수량이 재고보다 많습니다.');
                    return false;
                }
            });
        }

        // seller-header 클릭 바인딩 (inline onclick과 중복될 수 있으므로 중복 호출 방지)
        const sellerHeader = document.querySelector('.seller-header');
        if (sellerHeader) {
            sellerHeader.addEventListener('click', (e) => {
                // inline onclick도 있으면 두 번 호출될 수 있으므로 여기선 전역 함수를 직접 호출
                toggleSellerInfo();
            });
        }

        // 초기 화살표 표시 설정
        const sellerInfo = document.getElementById('seller-info');
        const sellerArrow = document.getElementById('arrow');
        if (sellerInfo && sellerArrow) {
            sellerArrow.textContent = sellerInfo.classList.contains('expanded') ? '▲' : '▼';
        }
    });
</script>

</body>
</html>