<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가계부 대시보드</title>

    <th:block layout:fragment="css">
        <link rel="stylesheet" href="/css/ledger.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    </th:block>

    <th:block layout:fragment="script">
        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script> <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>
        <script src="https://code.highcharts.com/modules/export-data.js"></script>
        <script src="https://code.highcharts.com/modules/accessibility.js"></script>
        <script defer src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

        <script src="/js/household/ledger.js"></script>
    </th:block>
</head>
<body>

<div layout:fragment="content">
    <button onclick="loadLedgerData()">데이터 불러오기</button>
    <div class="header-container mt-4 mobile-nav-only">
        <div class="month-nav">
            <button class="neo-btn" onclick="prevMonth()">&#9664;</button>
            <span id="mobileLabel" class="neo-label">2025년 10월</span>
            <button class="neo-btn" onclick="nextMonth()">&#9654;</button>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="chart-wrapper">
            <div id="categoryChart" style="width: 100%; height: 100%;"></div>
        </div>

        <div class="calendar-wrapper">
            <div class="desktop-nav-only mb-3" style="display:flex; justify-content:center; align-items:center;">
                <div class="month-nav">
                    <button class="neo-btn" onclick="prevMonth()" style="transform: scale(0.9);">&#9664;</button>
                    <span id="desktopLabel" class="neo-label" style="margin: 0 15px;">2025년 10월</span>
                    <button class="neo-btn" onclick="nextMonth()" style="transform: scale(0.9);">&#9654;</button>
                </div>
            </div>

            <div id="calendar"></div>
        </div>
    </div>

    <div class="container my-4">

        <h4 class="mb-3 fw-bold">이번 달 소비 요약</h4>
        <div id="top3Container" class="top3-wrapper">
            <div class="top3-card">
                <h6 class="card-label">Top 1</h6>
                <h4 class="card-category" id="top1-category">-</h4>
                <p class="small-text">내 지출</p>
                <div class="card-money" id="top1-my">- 원</div>
                <p class="small-text mt-3">전체 평균 대비</p>
                <div class="card-diff" id="top1-diff">- %</div>
                <div id="top1-chart" style="height:120px; margin-top:10px;"></div>
            </div>
            <div class="top3-card">
                <h6 class="card-label">Top 2</h6>
                <h4 class="card-category" id="top2-category">-</h4>
                <p class="small-text">내 지출</p>
                <div class="card-money" id="top2-my">- 원</div>
                <p class="small-text mt-3">전체 평균 대비</p>
                <div class="card-diff" id="top2-diff">- %</div>
                <div id="top2-chart" style="height:120px; margin-top:10px;"></div>
            </div>
            <div class="top3-card">
                <h6 class="card-label">Top 3</h6>
                <h4 class="card-category" id="top3-category">-</h4>
                <p class="small-text">내 지출</p>
                <div class="card-money" id="top3-my">- 원</div>
                <p class="small-text mt-3">전체 평균 대비</p>
                <div class="card-diff" id="top3-diff">- %</div>
                <div id="top3-chart" style="height:120px; margin-top:10px;"></div>
            </div>
        </div>

        <div id="lastMonthUserAvgContainer" class="last-month-box mt-4">
            <h4 class="section-title">📊 지난 달 사용자들의 카테고리 평균</h4>
            <div id="lastMonthAvgList" class="avg-list"></div>
            <p class="hint-text">※ 항목을 클릭하면 성별/연령대별 차트가 아래에 표시됩니다.</p>
            <div id="categorySelectList"></div>
        </div>
        <div id="categoryStatsCharts" class="last-month-box mt-3">
            <h4 id="statsChartTitle" class="section-title"></h4>
            <div class="row">
                <div class="col-md-6">
                    <div id="genderChartContainer" style="height:300px;"></div>
                </div>
                <div class="col-md-6">
                    <div id="ageChartContainer" style="height:300px;"></div>
                </div>
            </div>
        </div>

        <div id="dailyChart" style="width: 100%; height: 400px; max-width: 1200px; margin: 30px auto;"></div>
        <div id="threeMonthBarChart" style="width: 100%; height: 400px; max-width: 1200px; margin: 30px auto;"></div>

        <div class="table-wrapper mt-5" style="background:#fff; padding:25px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.05);">
            <div class="d-flex justify-content-between align-items-center mb-3"
                 style="cursor: pointer;"
                 data-bs-toggle="collapse"
                 data-bs-target="#transactionCollapse"
                 aria-expanded="true"
                 aria-controls="transactionCollapse">
                <h5 class="fw-bold m-0">📋 이번 달 거래 내역 상세</h5>
                <span class="toggle-icon">▼</span>
            </div>

            <div id="transactionCollapse" class="collapse">
                <table id="ledgerTable" class="display" style="width:100%">
                    <thead>
                    <tr>
                        <th>날짜</th>
                        <th>구분</th>
                        <th>카테고리</th>
                        <th>내용 (메모)</th>
                        <th>사용처</th>
                        <th>결제수단</th>
                        <th>금액</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button id="btnExcelExport"
                    class="btn btn-sm btn-outline-success"
                    onclick="exportExcel('you12zin345@gmail.com')"
                    style="display:none;">
                📥 엑셀로 내보내기
            </button>
        </div>

    </div> <div id="chartModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle"></h2>
        <div id="modalBody">
            <div id="modalCategoryChart" class="chart-container"></div>
            <div id="modalCompareSection" class="compare-section">
                <div class="compare-values">
                    <div class="value-box">
                        <span class="label">이번 달</span>
                        <span id="modalCurrentValue" class="value">0</span>
                    </div>
                    <div class="value-box">
                        <span class="label">최근 3개월 평균</span>
                        <span id="modalAverageValue" class="value">0</span>
                    </div>
                </div>
                <div id="modalCompareChart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

</div>
</body>
</html>