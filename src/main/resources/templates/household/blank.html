<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ë¶€ ëŒ€ì‹œë³´ë“œ</title>
    <!-- [í˜ì´ì§€ë³„ CSS] ë ˆì´ì•„ì›ƒì˜ css í”„ë˜ê·¸ë¨¼íŠ¸ì— ì‚½ì…ë¨ -->
    <th:block layout:fragment="css">
        <link rel="stylesheet" href="/css/ledger.css">
    </th:block>
    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- FullCalendar -->
    <script defer src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>

    <!-- CSS ë° JS ë¡œë“œ -->
    <link rel="stylesheet" href="/css/ledger.css">
    <script src="/js/household/ledger.js"></script>
</head>
<body>

<!-- [í˜ì´ì§€ë³„ ì½˜í…ì¸ ] ë ˆì´ì•„ì›ƒì˜ content í”„ë˜ê·¸ë¨¼íŠ¸ì— ì‚½ì…ë¨ -->
<div layout:fragment="content">
<!-- ìƒë‹¨ í—¤ë” (ë„¤ë¹„ê²Œì´ì…˜ + ìš”ì•½) -->
<div class="header-container mt-4">
    <!-- 1. ì›” ì´ë™ ë„¤ë¹„ê²Œì´ì…˜  -->
    <div id="monthNav" class="month-nav">
        <button class="neo-btn" onclick="prevMonth()">&#9664;</button>

        <span id="currentMonthLabel" class="neo-label">2025ë…„ 10ì›”</span>

        <button id="nextBtn" class="neo-btn" onclick="nextMonth()">&#9654;</button>
    </div>
</div>
    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ (ì°¨íŠ¸ + ìº˜ë¦°ë” ê°€ë¡œ ë°°ì¹˜) -->
    <div class="dashboard-container">
        <!-- ì™¼ìª½: ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ -->
        <div class="chart-wrapper">
            <div id="categoryChart" style="width: 100%; height: 100%;"></div>
        </div>

    <!-- ì˜¤ë¥¸ìª½: ìº˜ë¦°ë” -->
    <div class="calendar-wrapper">
        <div id="calendar"></div>
    </div>
</div>

<div class="container my-4">

    <!-- ì œëª© -->
    <h4 class="mb-3 fw-bold">ì´ë²ˆ ë‹¬ ì†Œë¹„ ìš”ì•½</h4>

    <div id="top3Container" class="top3-wrapper">

        <!-- ì¹´ë“œ 1 -->
        <div class="top3-card">
            <h6 class="card-label">ì¹´í…Œê³ ë¦¬</h6>
            <h4 class="card-category" id="top1-category">-</h4>

            <p class="small-text">ë‚´ ì§€ì¶œ</p>
            <div class="card-money" id="top1-my">- ì›</div>

            <p class="small-text mt-3">ì „ì²´ í‰ê·  ëŒ€ë¹„</p>
            <div class="card-diff" id="top1-diff">- %</div>

            <!-- ğŸ”¥ ì°¨íŠ¸ ë Œë”ë§ìš© div ì¶”ê°€ -->
            <div id="top1-chart" style="height:120px; margin-top:10px;"></div>
        </div>

        <!-- ì¹´ë“œ 2 -->
        <div class="top3-card">
            <h6 class="card-label">ì¹´í…Œê³ ë¦¬</h6>
            <h4 class="card-category" id="top2-category">-</h4>

            <p class="small-text">ë‚´ ì§€ì¶œ</p>
            <div class="card-money" id="top2-my">- ì›</div>

            <p class="small-text mt-3">ì „ì²´ í‰ê·  ëŒ€ë¹„</p>
            <div class="card-diff" id="top2-diff">- %</div>

            <!-- ğŸ”¥ ì°¨íŠ¸ ë Œë”ë§ìš© div ì¶”ê°€ -->
            <div id="top2-chart" style="height:120px; margin-top:10px;"></div>
        </div>

        <!-- ì¹´ë“œ 3 -->
        <div class="top3-card">
            <h6 class="card-label">ì¹´í…Œê³ ë¦¬</h6>
            <h4 class="card-category" id="top3-category">-</h4>

            <p class="small-text">ë‚´ ì§€ì¶œ</p>
            <div class="card-money" id="top3-my">- ì›</div>

            <p class="small-text mt-3">ì „ì²´ í‰ê·  ëŒ€ë¹„</p>
            <div class="card-diff" id="top3-diff">- %</div>

            <!-- ğŸ”¥ ì°¨íŠ¸ ë Œë”ë§ìš© div ì¶”ê°€ -->
            <div id="top3-chart" style="height:120px; margin-top:10px;"></div>
        </div>
    </div>

    <!-- ì§€ë‚œ ë‹¬ ì‚¬ìš©ì ì¹´í…Œê³ ë¦¬ í‰ê·  ì„¹ì…˜ -->
    <div id="lastMonthUserAvgContainer" class="last-month-box mt-4">

        <h4 class="section-title">ğŸ“Š ì§€ë‚œ ë‹¬ ì‚¬ìš©ìë“¤ì˜ ì¹´í…Œê³ ë¦¬ í‰ê· </h4>
        <div id="lastMonthAvgList" class="avg-list">
            <!-- ì¹´í…Œê³ ë¦¬/ê¸ˆì•¡ ë¦¬ìŠ¤íŠ¸ -->
        </div>
        <p class="hint-text">â€» í•­ëª©ì„ í´ë¦­í•˜ë©´ ì„±ë³„/ì—°ë ¹ëŒ€ë³„ ì°¨íŠ¸ê°€ ì•„ë˜ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        <div id="categorySelectList"></div>
    </div>

    <!-- ğŸ”» ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ë‚˜ì˜¤ëŠ” ìƒì„¸ ì°¨íŠ¸ ì˜ì—­ -->
    <div id="categoryStatsCharts" class="last-month-box mt-3">
        <h4 id="statsChartTitle" class="section-title"></h4>

        <div class="row">
            <div class="col-md-6">
                <div id="genderChartContainer" style="height:300px;"></div>
            </div>
            <div class="col-md-6">
                <div id="ageChartContainer" style="height:300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- í•˜ë‹¨: ì¼ë³„ ì°¨íŠ¸ -->
<div id="dailyChart" style="width: 100%; height: 400px; max-width: 1200px; margin: 30px auto;"></div>

    <!-- ë¹„êµ ì°¨íŠ¸ (ë§‰ëŒ€) -->
<div id="threeMonthBarChart" style="width: 100%; height: 400px; max-width: 1200px; margin: 30px auto;"></div>
<button onclick="exportExcel('you12zin345@gmail.com')">ì—‘ì…€ í…ŒìŠ¤íŠ¸</button>
<button onclick="loadLedgerData()">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <!-- ëª¨ë‹¬ -->
    <div id="chartModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>

            <!-- ì œëª© -->
            <h2 id="modalTitle"></h2>

            <div id="modalBody">
                <!-- ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ íŒŒì´ ì°¨íŠ¸ -->
                <div id="modalCategoryChart" class="chart-container"></div>

                <!-- ë¹„êµ ì„¹ì…˜ -->
                <div id="modalCompareSection" class="compare-section">
                    <!-- ê¸ˆì•¡ ë¹„êµ -->
                    <div class="compare-values">
                        <div class="value-box">
                            <span class="label">ì´ë²ˆ ë‹¬</span>
                            <span id="modalCurrentValue" class="value">0</span>
                        </div>

                        <div class="value-box">
                            <span class="label">ìµœê·¼ 3ê°œì›” í‰ê· </span>
                            <span id="modalAverageValue" class="value">0</span>
                        </div>
                    </div>

                    <!-- ë¹„êµ ì°¨íŠ¸ (ë§‰ëŒ€) -->
                    <div id="modalCompareChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- [í˜ì´ì§€ë³„ JS] ë ˆì´ì•„ì›ƒì˜ script í”„ë˜ê·¸ë¨¼íŠ¸ì— ì‚½ì…ë¨ -->
    <th:block layout:fragment="script">
        <!-- Highcharts -->
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>
        <script src="https://code.highcharts.com/modules/export-data.js"></script>
        <script src="https://code.highcharts.com/modules/accessibility.js"></script>

        <!-- FullCalendar -->
        <script defer src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>

        <!-- CSS ë° JS ë¡œë“œ -->
        <script src="/js/household/ledger.js"></script>


<!-- ìŠ¤í¬ë¦½íŠ¸: ìº˜ë¦°ë” ì´ˆê¸°í™” -->
<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var currentMonthLabel = document.getElementById('currentMonthLabel');

        var initialDate = '2025-10-01';

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            initialDate: initialDate,
            height: '100%',
            contentHeight: 'auto',

            // â˜… ì¤‘ìš”: ì´ë²¤íŠ¸ ì •ë ¬ ìˆœì„œ (ìˆ˜ì… -> ì§€ì¶œ)
            eventOrder: 'order',

            // ë‚ ì§œ ìˆ«ì ì²˜ë¦¬
            dayCellContent: function(arg) {
                var text = arg.dayNumberText || '';
                return { html: text.replace('ì¼', '') };
            },

            // â˜… ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ìƒ‰ìƒ ì²˜ë¦¬ â˜…
            events:async function(info, successCallback, failureCallback) {
                // í˜„ì¬ ì›” ê³„ì‚°
                var viewMidDate = new Date((info.start.getTime() + info.end.getTime()) / 2);
                var year = viewMidDate.getFullYear();
                var month = viewMidDate.getMonth() + 1;

                console.log(`[ìº˜ë¦°ë”] ë°ì´í„° ìš”ì²­: ${year}ë…„ ${month}ì›”`);

                    // ì„œë²„ API í˜¸ì¶œ
                    try {
                        const response = await fetch(`/ledger/calendar?year=${year}&month=${month}`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        var events = [];
                        var totalIncome = 0;
                        var totalExpense = 0;

                        // 1. ìƒ‰ìƒ ë†ë„ë¥¼ ìœ„í•´ ì´ë²ˆ ë‹¬ì˜ ìµœëŒ€ ìˆ˜ì…/ì§€ì¶œ ê¸ˆì•¡ ì°¾ê¸°
                        let maxIncome = 0;
                        let maxExpense = 0;

                        data.forEach(day => {
                            if (day.income > maxIncome) maxIncome = day.income;
                            if (day.expense > maxExpense) maxExpense = day.expense;
                        });

                        // 2. ì´ë²¤íŠ¸ ìƒì„±
                        data.forEach(function (day) {
                            // (1) ìˆ˜ì… ì´ë²¤íŠ¸ (íŒŒë€ìƒ‰ ê³„ì—´)
                            if (day.income > 0) {
                                // ë†ë„ ê³„ì‚° (ìµœì†Œ 0.1 ~ ìµœëŒ€ 0.8)
                                let alpha = 0.1;
                                if (maxIncome > 0) {
                                    alpha = 0.1 + (day.income / maxIncome) * 0.7;
                                }

                                events.push({
                                    title: '+' + Math.floor(day.income).toLocaleString(),
                                    start: day.date,
                                    classNames: ['income-event'],
                                    backgroundColor: `rgba(13, 110, 253, ${alpha})`, // Bootstrap Primary Blue ê³„ì—´
                                    borderColor: `rgba(13, 110, 253, ${alpha})`,
                                    textColor: alpha > 0.5 ? '#fff' : '#004085', // ë°°ê²½ ì§„í•˜ë©´ í° ê¸€ì”¨
                                    display: 'block',
                                    extendedProps: {order: 1} // ì •ë ¬ ìˆœì„œ 1 (ìƒë‹¨)
                                });
                                totalIncome += day.income;
                            }

                            // (2) ì§€ì¶œ ì´ë²¤íŠ¸ (ë¹¨ê°„ìƒ‰ ê³„ì—´)
                            if (day.expense > 0) {
                                // ë†ë„ ê³„ì‚°
                                let alpha = 0.1;
                                if (maxExpense > 0) {
                                    alpha = 0.1 + (day.expense / maxExpense) * 0.7;
                                }

                                events.push({
                                    title: '-' + Math.floor(day.expense).toLocaleString(),
                                    start: day.date,
                                    classNames: ['expense-event'],
                                    backgroundColor: `rgba(220, 53, 69, ${alpha})`, // Bootstrap Danger Red ê³„ì—´
                                    borderColor: `rgba(220, 53, 69, ${alpha})`,
                                    textColor: alpha > 0.5 ? '#fff' : '#721c24', // ë°°ê²½ ì§„í•˜ë©´ í° ê¸€ì”¨
                                    display: 'block',
                                    extendedProps: {order: 2} // ì •ë ¬ ìˆœì„œ 2 (í•˜ë‹¨)
                                });
                                totalExpense += day.expense;
                            }
                        });

                        // ìƒë‹¨ ìš”ì•½ ì—…ë°ì´íŠ¸
                        updateSummary(totalIncome, totalExpense);

                        successCallback(events);
                    } catch (error) {
                        console.error("ìº˜ë¦°ë” ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                        failureCallback(error);
                    }
                },
                dateClick: function(info) {
                    document.getElementById('modalTitle').innerText = info.dateStr + " ìƒì„¸ ë‚´ì—­";
                    document.getElementById('modalBody').innerHTML = "<p>ë°ì´í„° ì¡°íšŒ ì¤‘...</p>";
                    document.getElementById('chartModal').style.display = 'flex';
                }
            });

            calendar.render();

        // document.getElementById('prevBtn').addEventListener('click', function() {
        //     calendar.prev();
        //     updateLabel();
        // });
        //
        // document.getElementById('nextBtn').addEventListener('click', function() {
        //     calendar.next();
        //     updateLabel();
        // });

            function updateLabel() {
                var date = calendar.getDate();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                document.getElementById('currentMonthLabel').innerText = year + "ë…„ " + month + "ì›”";
            }

            function updateSummary(income, expense) {
                var incomeEl = document.getElementById('totalIncomeLabel');
                var expenseEl = document.getElementById('totalExpenseLabel');
                if(incomeEl) incomeEl.innerText = 'ìˆ˜ì… ' + Math.floor(income).toLocaleString() + 'ì›';
                if(expenseEl) expenseEl.innerText = 'ì§€ì¶œ ' + Math.floor(expense).toLocaleString() + 'ì›';
            }

            updateLabel();
        });

        function closeModal() {
            document.getElementById('chartModal').style.display = 'none';
        }
    </script>
</th:block>

    </body>
</html>